<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DynamicGraph.js</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
    <link href="libraries/chosen.min.css" rel="stylesheet">
    <style>
        body {
            margin-left: 30px;
        }

        #wrapper {
            display: grid;
            grid-gap: 10px;
            grid-template-columns: 5% 50%; 
        }

        #wrapper > span {
            grid-column: 1 / 2;
            margin-left: 10px;
            line-height: 30px;
            font-weight: bold;
        }

        .chosen-select {
            grid-column: 2 / 2;
        }

        .optionPanel {
            position: absolute;
            width: 200px;
            z-index: 100;
            background-color: white;
            border: solid 1px #337ab7;
            padding: 5px;
            border-radius: 3px;
        }

        .optionPanel div {
            padding: 0px !important;
            margin: 0px !important;
        }

        .arrow {
            border: solid transparent 10px;
            border-bottom-color: #337ab7;
            width: 0px;
            height: 0px;
            position: absolute;
            z-index: 100;
        }

        #yAxis_chosen .sum::before {
            content: "sum(";
            color: gray;
        }

        #yAxis_chosen .sum::after {
            content: ")";
            color: gray;
        }

        #yAxis_chosen .avg::before {
            content: "avg(";
            color: gray;
        }

        #yAxis_chosen .avg::after {
            content: ")";
            color: gray;
        }

        #yAxis_chosen .max::before {
            content: "max(";
            color: gray;
        }

        #yAxis_chosen .max::after {
            content: ")";
            color: gray;
        }

        #yAxis_chosen .min::before {
            content: "min(";
            color: gray;
        }

        #yAxis_chosen .min::after {
            content: ")";
            color: gray;
        }

        #filter_chosen span[data-filter]::after {
            content: " " attr(data-filter);
            color: gray;
        }
    </style>
</head>

<body>
    <h2>This is an interactive example of DynamicGraph.js.</h2>
    <h4>More information can be found on <a href="https://github.com/RobinWeitzel/DynamicGraph.js">Github</a>.</h4>
<div id="wrapper">
    <span>x-Axis: </span><select class="chosen-select" multiple id="xAxis"></select>
    <span>y-Axis: </span><select class="chosen-select" multiple id="yAxis"></select>
    <span>Filter: </span><select class="chosen-select" multiple id="filter"></select>
</div>
<div>
    <canvas id="myChart" width="800" height="400"></canvas>
</div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js" type="text/javascript"></script>
    <script src="libraries/chosen.jquery.js" type="text/javascript"></script>
    <script src="../src/dynamicgraph.js" type="text/javascript"></script>
    <script>
        
        // Example data
        const map = new Map();
        map.set('first', "David");
        map.set('last', "Miller");

        const data = [
            ['sum', 'user', 'time'],
            [10, { id: 1, name: map }, 1],
            [2, { id: 2, name: { first: 'Alex', last: 'Miller' } }, 2],
            [5, { id: 3, name: { first: 'Julia', last: 'Smith' } }, 3]
        ];

        // Graph.js options
        const options = {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
            responsive: false
        };

        const graph = new DynamicGraph("myChart");

        let labels = graph.loadArray(data);
        labels.forEach(l => $('.customSelect, .chosen-select').append(`<option>${l}</option>`));

        $(".chosen-select").chosen().change(function(evt, params) {
            updateGraph();
            $('.chosen-container span').off('click');
            $('.chosen-container span').on('click', function(e) {
                e.stopPropagation();
            });
        });

        function onOptionDestroy() {
            updateGraph();
            removePopups();
        }

        function spanClick(evt) {
            $('.arrow').remove();
            $('.optionPanel').remove();
            $('.selected').removeClass('selected');

            if($(evt.target).parents('#xAxis_chosen').length > 0) return;

            const position = $(evt.target).offset(); 
            const top = position.top + $(evt.target).height();
            const left = position.left + $(evt.target).outerWidth() / 5;

            const arrow = $(`<div class="arrow"></div>`).appendTo('body');
            arrow.css({top: top, left: left});

            $(evt.target).addClass('selected');

            let html;
            if($(evt.target).parents('#yAxis_chosen').length > 0) {
                html = `<div class="optionPanel">
                        <label>Aggregation:</label>
                        <div class="list-group">
                            <a href="#" class="list-group-item ${$(evt.target).hasClass('sum') ? 'active' : ''}">sum</a>
                            <a href="#" class="list-group-item ${$(evt.target).hasClass('avg') ? 'active' : ''}">avg</a>
                            <a href="#" class="list-group-item ${$(evt.target).hasClass('max') ? 'active' : ''}">max</a>
                            <a href="#" class="list-group-item ${$(evt.target).hasClass('min') ? 'active' : ''}">min</a>
                        </div>
                    </div>`;    
            } else if ($(evt.target).parents('#filter_chosen').length > 0) {
                html = `<div class="optionPanel">
                        <div class="form-group">
                          <label>Filter:</label>
                          <input type="text" class="form-control filterInput" value='${$(evt.target).attr('data-filter')}'>
                        </div>
                    </div>`; 
            }
            const div = $(html).appendTo('body');
            div.css({top: top + 20, left: left - 20});  
            $('.filterInput').focus();      
        }

        $(document).on('click', function(e) {
            if($(e.target).parent('.search-choice').length > 0 || $(e.target).hasClass('optionPanel') || $(e.target).parents('.optionPanel').length > 0 || $(e.target).hasClass('arrow')) {
                e.stopPropagation();
                return;
            }   
            removePopups();      
        });

        function removePopups() {
            $('.arrow').remove();
            $('.optionPanel').remove();
            $('span').removeAttr('data-target');
            $('.selected').removeClass('selected');
        }

        $(document).on('click', '.list-group-item', function() {
            $('.list-group-item').removeClass('active');
            $(this).addClass('active');

            $('.selected').removeClass('sum avg max min');
            $('.selected').addClass($(this).text());
            updateGraph();
            removePopups();
        }); 

        $(document).on('input', '.filterInput', function() {
            $('.selected').attr('data-filter', $(this).val());
        });

        $(document).on('keypress', '.filterInput', function(e) {
            if(e.which == 13) {
                updateGraph();
                removePopups();
            }
        });

        function updateGraph() {
            const xAxis = [];
            $('#xAxis_chosen > .chosen-choices span').each(function() {
                xAxis.push($(this).text());
            });

            const yAxis = [];
            $('#yAxis_chosen > .chosen-choices span').each(function() {
                let mode = "sum";
                if($(this).hasClass('avg')) mode = "avg";
                if($(this).hasClass('max')) mode = "max";
                if($(this).hasClass('min')) mode = "min";

                yAxis.push({label: $(this).text(), mode: mode});
            });

            const filter = [];
            $('#filter_chosen > .chosen-choices span').each(function() {
                filter.push({label: $(this).text(), condition: $(this).attr('data-filter')});
            });

            graph.createGraphFromMemory('bar', xAxis, yAxis, filter, 'blue', options);
        }

    </script>
</body>

</html>